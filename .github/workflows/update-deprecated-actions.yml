name: Update Deprecated GitHub Actions

on:
  schedule:
    # Run weekly on Mondays at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  update-actions:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Scan and update deprecated actions
      id: update
      run: |
        set -e
        
        # Define replacements for deprecated actions
        declare -A replacements=(
          ["actions/checkout@v1"]="actions/checkout@v4"
          ["actions/checkout@v2"]="actions/checkout@v4"
          ["actions/checkout@v3"]="actions/checkout@v4"
          ["actions/setup-node@v1"]="actions/setup-node@v4"
          ["actions/setup-node@v2"]="actions/setup-node@v4"
          ["actions/setup-node@v3"]="actions/setup-node@v4"
          ["actions/setup-python@v1"]="actions/setup-python@v5"
          ["actions/setup-python@v2"]="actions/setup-python@v5"
          ["actions/setup-python@v3"]="actions/setup-python@v5"
          ["actions/setup-python@v4"]="actions/setup-python@v5"
          ["actions/cache@v1"]="actions/cache@v4"
          ["actions/cache@v2"]="actions/cache@v4"
          ["actions/cache@v3"]="actions/cache@v4"
          ["actions/upload-artifact@v1"]="actions/upload-artifact@v4"
          ["actions/upload-artifact@v2"]="actions/upload-artifact@v4"
          ["actions/upload-artifact@v3"]="actions/upload-artifact@v4"
          ["actions/download-artifact@v1"]="actions/download-artifact@v4"
          ["actions/download-artifact@v2"]="actions/download-artifact@v4"
          ["actions/download-artifact@v3"]="actions/download-artifact@v4"
          ["google-github-actions/auth@v0"]="google-github-actions/auth@v2"
          ["google-github-actions/auth@v1"]="google-github-actions/auth@v2"
          ["google-github-actions/setup-gcloud@v0"]="google-github-actions/setup-gcloud@v2"
          ["google-github-actions/setup-gcloud@v1"]="google-github-actions/setup-gcloud@v2"
        )
        
        # Find all workflow files (excluding this workflow to avoid self-updates)
        workflow_files=$(find .github/workflows -name "*.yml" -o -name "*.yaml" | grep -v "update-deprecated-actions.yml" || true)
        
        if [ -z "$workflow_files" ]; then
          echo "No workflow files found"
          echo "has_changes=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Track if any changes were made
        changes_made=false
        updated_files=""
        
        # Process each workflow file
        for file in $workflow_files; do
          echo "Scanning $file..."
          file_modified=false
          
          for old_action in "${!replacements[@]}"; do
            new_action="${replacements[$old_action]}"
            
            if grep -q "$old_action" "$file"; then
              echo "  Found deprecated action: $old_action"
              echo "  Replacing with: $new_action"
              sed -i "/uses:/s|$old_action|$new_action|g" "$file"
              file_modified=true
              changes_made=true
            fi
          done
          
          if [ "$file_modified" = true ]; then
            updated_files="${updated_files}$'\n'- ${file}"
          fi
        done
        
        # Set output
        if [ "$changes_made" = true ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo -e "updated_files<<EOF" >> $GITHUB_OUTPUT
          echo -e "$updated_files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "No deprecated actions found"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Create Pull Request
      if: steps.update.outputs.has_changes == 'true'
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore: update deprecated GitHub Actions to latest versions'
        title: 'chore: Update Deprecated GitHub Actions'
        body: |
          ## Automated Update: Deprecated GitHub Actions
          
          This PR updates deprecated GitHub Actions to their latest versions.
          
          ### Changes Made
          ${{ steps.update.outputs.updated_files }}
          
          ### Updated Actions
          - `actions/checkout` v1-v3 → v4
          - `actions/setup-node` v1-v3 → v4
          - `actions/setup-python` v1-v4 → v5
          - `actions/cache` v1-v3 → v4
          - `actions/upload-artifact` v1-v3 → v4
          - `actions/download-artifact` v1-v3 → v4
          - `google-github-actions/auth` v0-v1 → v2
          - `google-github-actions/setup-gcloud` v0-v1 → v2
          
          ### Why This Update?
          - Older action versions may be deprecated and could stop working
          - Newer versions include security fixes and performance improvements
          - Maintains compatibility with latest GitHub Actions features
          
          This PR was automatically created by the Update Deprecated Actions workflow.
        branch: automated/update-deprecated-actions
        delete-branch: true
        labels: |
          dependencies
          automated
          github-actions
